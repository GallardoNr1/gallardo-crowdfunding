---
import ContributionLevels from '@/components/ContributionLevels.astro';
import ContributorsListReact from '@/components/ContributorsListReact.astro';
import FamilyPhotos from '@/components/FamilyPhotos.astro';
import MessageSection from '@/components/MessageSection.astro';
import ProductCard from '@/components/ProductCard.astro';
import ProgressSection from '@/components/ProgressSection.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Footer from '@/layouts/Footer.astro';
import {
  getProjectConfig,
  getContributionLevels,
  getPublicContributions,
  getFamilyMembers,
  type ContributionLevel,
  type FamilyMember,
  type PublicContribution,
  getImagesFromFolder,
} from '@/lib/supabase';

export const prerender = false;

// Obtener configuraci√≥n del proyecto desde Supabase
let projectConfig = null;
let errorLoadingConfig = false;
let contributionLevels: ContributionLevel[] = [];
let contibutionsList: PublicContribution[] = [];
let familyMembers: FamilyMember[] = [];
let photos: string[] = [];

const url = new URL(Astro.request.url);
const id = url.searchParams.get('id') || '';

try {
  projectConfig = await getProjectConfig(id);
  contributionLevels = await getContributionLevels(id);
  contibutionsList = await getPublicContributions(id);
  familyMembers = await getFamilyMembers(id);
  photos = await getImagesFromFolder(id);
} catch (error) {
  console.error('Error loading data base:', error);
  errorLoadingConfig = true;
}

const completed = projectConfig?.project_status === 'completed';

// Datos del producto (por defecto: tablet de Ana)
const productData = {
  title: projectConfig?.project_name || 'Tablet para el cumplea√±os de Ana',
  description:
    projectConfig?.project_description ||
    'Este crowdfunding es un regalo de cumplea√±os para Ana, una mujer incre√≠ble, madre de 7 hijos y profe entregada. Queremos ayudarla a conseguir una tablet Lenovo que le sirva para preparar sus clases, corregir, organizarse mejor y, aun as√≠, seguir cuidando de todos nosotros. Si te apetece participar, cualquier aportaci√≥n suma y es un gesto de cari√±o hacia ella.',
  price: projectConfig?.target_amount || 159.0,
  imageUrl:
    projectConfig?.project_image_url ||
    'https://p2-ofp.static.pub/medias/1272005020_1280x720.png',
  imageAlt: 'Tablet Lenovo Idea Tab 11 ZAFR0389ES',
};

const mainMessage = `¬°Hola familia y amigos queridos! üíñüì±
Este a√±o queremos hacer algo muy especial para alguien que lo merece m√°s que nadie: Ana.
Como sab√©is, es una mujer incre√≠ble, entregada, fuerte, generosa y capaz de sostener una familia enorme con una sonrisa. No solo es el coraz√≥n de nuestro hogar, tambi√©n es una profesora excepcional, que pone el alma en todo lo que hace.
Por eso queremos regalarle algo que realmente le ayude en su d√≠a a d√≠a: una tablet Lenovo Idea Tab 11, que usar√° tanto para preparar sus clases como para seguir form√°ndose, organizarse mejor, leer, estudiar y, por qu√© no‚Ä¶ ¬°disfrutar de sus momentos de descanso!
Queremos que este regalo sea especial, algo que venga no solo de m√≠, sino de todos los que la queremos: familia de ambos lados, amigos cercanos, quienes la conocen y saben el enorme cari√±o que se merece.
Este crowdfunding es una invitaci√≥n a participar en su sorpresa de cumplea√±os.
Cada aportaci√≥n, por peque√±a que sea, suma y significa much√≠simo.
Es una manera de decirle: *‚Äúte apoyamos, te valoramos y queremos que
tengas herramientas que te faciliten la vida y te acompa√±en en tu camino‚Äù*.
Gracias de coraz√≥n por uniros a este regalo tan especial para una mujer extraordinaria que lo da todo, cada d√≠a, por su familia y por sus alumnos.
¬°Vamos a hacerle el cumplea√±os m√°s bonito del mundo! üéâ‚ù§Ô∏è`;

const callToAction = {
  icon: 'üéÅ',
  title: '¬øNos ayudas?',
  text: 'Tu apoyo significa much√≠simo para esta sorpresa.',
  stats: [
    { number: '128GB', label: 'Almacenamiento' },
    { number: '8GB', label: 'RAM' },
    { number: '‚úîÔ∏è', label: 'Ideal para su trabajo' },
  ],
};

const tabletPhotos = [
  { emoji: 'üçé', caption: 'Su pasi√≥n por ense√±ar' },
  { emoji: 'üìö', caption: 'Preparando clases con cari√±o' },
  { emoji: 'üë©‚Äçüè´', caption: 'Inspirando a sus alumnos' },
  { emoji: 'üíª', caption: 'Trabajando sin parar por su familia' },
];

const photoSection = {
  title: 'üì∏ Momentos Bonitos del D√≠a a D√≠a de Ana',
  photos: tabletPhotos,
};
---

<BaseLayout
  title='üéÅ Cumplea√±os de Ana'
  subtitle='ayudemos con su nueva tablet'
>
  <div class='container'>
    {
      errorLoadingConfig && (
        <div class='global-error-banner'>
          <div class='error-content'>
            <span class='error-icon'>‚ö†Ô∏è</span>
            <div class='error-text'>
              <strong>Modo de demostraci√≥n:</strong>
              Algunos datos son de ejemplo debido a problemas de conexi√≥n con la
              base de datos.
            </div>
          </div>
        </div>
      )
    }

    <ProductCard
      title={productData.title}
      description={productData.description}
      price={productData.price}
      href='https://www.mediamarkt.es/es/product/_tablet-lenovo-idea-tab-wifi-11-25k-8gb-ram-128gb-gris-incluye-lapiz-1603847.html'
      imageUrl={productData.imageUrl}
      imageAlt={productData.imageAlt}
      completed={completed}
    />

    <ProgressSection
      currentAmount={contibutionsList.reduce((sum, c) => sum + c.amount, 0)}
      targetAmount={projectConfig?.target_amount ?? 0}
      title='üéØ Un Peque√±o Empuj√≥n Para Una Gran Mujer'
    />

    {
      photos.length > 0 && (
        <FamilyPhotos
          title={photoSection.title}
          photos={photos}
          altPreText='Foto familiar'
        />
      )
    }

    {
      !completed &&
        <ContributionLevels levels={contributionLevels} />
          <ContributorsListReact
          contributors={contibutionsList}
          contributorsTitle='‚ú® Impulsores de Este Regalo Especial'
          />
    }

    <MessageSection
      familyMembers={familyMembers}
      mainMessage={mainMessage}
      memberTitle='üå∏ La Tribu Que Le Da Alas'
      callToAction={callToAction}
      project_id={projectConfig?.id || ''}
    />
  </div>
  <Footer slot='footer' />
</BaseLayout>

<style>
  .global-error-banner {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
    border: 2px solid #ffc107;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
  }

  .error-content {
    display: flex;
    align-items: center;
    gap: 15px;
    text-align: center;
    justify-content: center;
  }

  .error-icon {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .error-text {
    color: #856404;
    font-size: 1rem;
    line-height: 1.4;
  }

  .error-text strong {
    color: #533f03;
  }

  .status-active {
    color: #4caf50;
    font-weight: 600;
  }

  .status-completed {
    color: #2196f3;
    font-weight: 600;
  }

  .status-paused {
    color: #ff9800;
    font-weight: 600;
  }

  .status-cancelled {
    color: #f44336;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .footer-content {
      padding: 30px 20px;
    }

    .footer-message h3 {
      font-size: 1.5rem;
    }

    .footer-stats {
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .footer-links {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .footer-separator {
      display: none;
    }

    .global-error-banner {
      margin: 10px;
      padding: 15px;
    }

    .error-content {
      flex-direction: column;
      gap: 10px;
    }
  }
</style>

<script>
  // Manejar eventos de contribuci√≥n completada
  document.addEventListener('contributionCompleted', (event: any) => {
    const { amount, contributor } = event.detail;

    // Mostrar celebraci√≥n global
    showGlobalCelebration(contributor);

    // Actualizar t√≠tulo de la p√°gina si es necesario
    if (typeof document !== 'undefined') {
      const originalTitle = document.title;
      document.title = `üéâ ¬°Nueva contribuci√≥n! - ${originalTitle}`;

      // Restaurar t√≠tulo despu√©s de 5 segundos
      setTimeout(() => {
        document.title = originalTitle;
      }, 5000);
    }
  });

  function showGlobalCelebration(contributor: any) {
    const celebration = document.createElement('div');
    celebration.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        `;

    for (let i = 0; i < 100; i++) {
      setTimeout(() => {
        createGlobalConfetti(celebration);
      }, i * 30);
    }

    document.body.appendChild(celebration);

    showContributionNotification(contributor);

    setTimeout(() => {
      if (document.body.contains(celebration)) {
        document.body.removeChild(celebration);
      }
    }, 8000);
  }

  function createGlobalConfetti(container: HTMLElement) {
    const confetti = document.createElement('div');
    const emojis = ['üéâ', '‚ú®', 'üåü', 'üí´', 'üéä', 'üéÅ', 'üíù', 'üìö', 'üë©‚Äçüè´', 'üì±'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];

    confetti.textContent = emoji;
    confetti.style.cssText = `
            position: absolute;
            font-size: ${Math.random() * 25 + 15}px;
            left: ${Math.random() * 100}vw;
            top: -50px;
            animation: globalConfettiFall ${Math.random() * 4 + 3}s linear forwards;
            transform: rotate(${Math.random() * 360}deg);
            z-index: 10000;
        `;

    container.appendChild(confetti);

    setTimeout(() => {
      if (container.contains(confetti)) {
        container.removeChild(confetti);
      }
    }, 8000);
  }

  function showContributionNotification(contributor: any) {
    const notification = document.createElement('div');
    notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, #4caf50, #45a049);
            color: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
            z-index: 10001;
            animation: slideInRight 0.5s ease-out;
            max-width: 300px;
            font-family: 'Poppins', sans-serif;
        `;

    notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <span style="font-size: 1.5rem;">${contributor.emoji}</span>
                <strong style="font-size: 1.1rem;">¬°Nueva contribuci√≥n!</strong>
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                <strong>${contributor.name}</strong> se uni√≥ como <strong>${contributor.level}</strong>
                ${contributor.message ? `<br><em>"${contributor.message}"</em>` : ''}
            </div>
        `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.5s ease-in';
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 6000);
  }

  const globalStyles = document.createElement('style');
  globalStyles.textContent = `
        @keyframes globalConfettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        .container {
            position: relative;
            z-index: 1;
        }

        html {
            scroll-behavior: smooth;
        }

        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .connection-status.offline {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
    `;
  document.head.appendChild(globalStyles);

  // function updateConnectionStatus() {
  //   let statusIndicator = document.getElementById('connectionStatus');

  //   if (!statusIndicator) {
  //     statusIndicator = document.createElement('div');
  //     statusIndicator.id = 'connectionStatus';
  //     statusIndicator.className = 'connection-status';
  //     document.body.appendChild(statusIndicator);
  //   }

  //   if (navigator.onLine) {
  //     statusIndicator.className = 'connection-status online';
  //     statusIndicator.textContent = 'üü¢ Conectado';
  //   } else {
  //     statusIndicator.className = 'connection-status offline';
  //     statusIndicator.textContent = 'üî¥ Sin conexi√≥n';
  //   }
  // }

  // window.addEventListener('online', updateConnectionStatus);
  // window.addEventListener('offline', updateConnectionStatus);

  document.addEventListener('DOMContentLoaded', () => {
    // updateConnectionStatus();

    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px',
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, observerOptions);

    const sections = document.querySelectorAll(
      '.main-card, .progress-section, .contributors-section, .message-section'
    );
    sections.forEach((section) => observer.observe(section));
  });

  (window as any).debugCrowdfunding = {
    triggerTestContribution: () => {
      const testContribution = {
        amount: 25,
        contributor: {
          name: 'Usuario de Prueba',
          emoji: 'üß™',
          level: 'Colaborador',
          message: 'Esta es una contribuci√≥n de prueba',
          color: '#ff9800',
          isAnonymous: false,
        },
      };

      document.dispatchEvent(
        new CustomEvent('contributionCompleted', {
          detail: testContribution,
        })
      );
    },

    getComponentsStatus: () => {
      return {
        contributionLevels: !!(window as any).contributionLevels,
        contributorsList: !!(window as any).contributorsList,
        contributionModal: !!(window as any).contributionModal,
        messageSection: !!(window as any).messageSection,
      };
    },
  };
</script>
