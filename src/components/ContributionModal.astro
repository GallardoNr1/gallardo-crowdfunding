---
import type { PaymentMethodConfig, EmojiOption } from '@/lib/supabase';
import Modal from './UI/Modal.astro';

export interface Props {
  paymentMethods?: PaymentMethodConfig[];
  currency?: string;
  modalTitle?: string;
  modalIcon?: string;
  modalSubtitle?: string;

  summaryTitle?: string;
  formTitle?: string;
  paymentTitle?: string;

  successTitle?: string;
  successMessage?: string;

  cancelButtonText?: string;
  confirmButtonText?: string;

  totalLabel?: string;

  emojiOptions?: EmojiOption[];
  projectId?: string;

  // Fallbacks por si no vienen en config
  bizumNumber?: string;
  bizumConcept?: string;
}

const {
  paymentMethods = [
    { id: 'cash', payment_method: 'cash', is_active: true },
    { id: 'bizum', payment_method: 'bizum', is_active: true },
  ],
  currency = '‚Ç¨',
  emojiOptions,
  projectId = '',
  bizumNumber = '',
  bizumConcept = '',
} = Astro.props;

const {
  modalTitle = '¬°√önete a la Aventura!',
  modalIcon = 'üêâ',
  modalSubtitle = 'Ayuda a la familia a conseguir su drag√≥n √©pico',
  summaryTitle = 'üìù Resumen de tu Contribuci√≥n',
  formTitle = 'üë§ Tus Datos de H√©roe',
  paymentTitle = 'üí≥ M√©todo de Pago',
  successTitle = '¬°Contribuci√≥n Registrada!',
  successMessage = '¬°Gracias por unirte a nuestra aventura √©pica! üêâ',
  cancelButtonText = 'Cancelar',
  confirmButtonText = '¬°Contribuir Ahora!',
  totalLabel = 'Total a contribuir:',
} = Astro.props;
---

<Modal
  id='contributionModal'
  title={modalTitle}
>
  <div
    class='modal-icon'
    slot='beforeTitle'
    id='levelEmoji'
  >
    {modalIcon}
  </div>
  <p
    class='modal-subtitle'
    slot='afterTitle'
  >
    {modalSubtitle}
  </p>

  <!-- Datos inyectados para script cliente -->
  <div
    id='contributionModalData'
    style='display:none'
    data-payment-methods={JSON.stringify(paymentMethods)}
    data-currency={currency}
    data-confirm-text={confirmButtonText}
    data-cancel-text={cancelButtonText}
    data-success-title={successTitle}
    data-success-message={successMessage}
    data-project-id={projectId}
    data-bizum-number={bizumNumber}
    data-bizum-concept={bizumConcept}
  >
  </div>

  <div class='dialog-content'>
    <form
      id='contributionForm'
      class='contribution-form'
    >
      <div class='modal-body'>
        <section class='contribution-summary'>
          <div class='summary-header'>
            <h3>{summaryTitle}</h3>
          </div>

          <div
            class='selected-level'
            id='selectedLevelDisplay'
          >
            <div class='level-info'>
              <div class='level-details'>
                <div
                  class='level-name'
                  id='levelName'
                >
                  Selecciona un nivel
                </div>
                <div
                  class='level-description'
                  id='levelDescription'
                >
                  Elige un nivel de contribuci√≥n
                </div>
              </div>
              <div
                class='level-amount'
                id='levelAmount'
              >
                0 {currency}
              </div>
            </div>
          </div>

          <input
            type='hidden'
            id='selectedLevelId'
            name='levelId'
            required
          />
          <input
            type='hidden'
            id='selectedAmount'
            name='amount'
            required
          />
        </section>

        <section class='contributor-form'>
          <h3 class='form-title'>{formTitle}</h3>

          <div class='form-grid'>
            <div class='form-group'>
              <label for='contributorName'>Nombre *</label>
              <input
                type='text'
                id='contributorName'
                name='contributorName'
                placeholder='¬øC√≥mo te llamaremos?'
                required
                minlength='2'
                autocomplete='name'
              />
              <div
                class='input-icon'
                aria-hidden='true'
              >
                ‚öîÔ∏è
              </div>
            </div>

            <div class='form-group'>
              <label for='contributorEmail'>Email *</label>
              <input
                type='email'
                id='contributorEmail'
                name='contributorEmail'
                placeholder='tu.email@aventura.com'
                required
                autocomplete='email'
              />
              <div
                class='input-icon'
                aria-hidden='true'
              >
                üìß
              </div>
            </div>

            <div class='form-group full-width'>
              <label for='contributorMessage'>Mensaje de Apoyo (opcional)</label
              >
              <textarea
                id='contributorMessage'
                name='contributorMessage'
                placeholder='Deja un mensaje...'
                maxlength='150'
                rows='3'
              ></textarea>
              <div
                class='char-counter'
                id='charCounter'
                aria-live='polite'
              >
                0/150
              </div>
            </div>

            <div class='form-group'>
              <label for='contributorEmoji'>Tu Emoji</label>
              <select
                id='contributorEmoji'
                name='contributorEmoji'
              >
                {
                  emojiOptions?.map((opt) => (
                    <option value={opt.value}>
                      {opt.value} {opt.label}
                    </option>
                  ))
                }
              </select>
            </div>

            <div class='form-group'>
              <div class='checkbox-group'>
                <input
                  type='checkbox'
                  id='isAnonymous'
                  name='isAnonymous'
                />
                <label for='isAnonymous'>ü•∑ Contribuci√≥n an√≥nima</label>
              </div>
            </div>
          </div>
        </section>

        <section class='payment-section'>
          <h3 class='payment-title'>{paymentTitle}</h3>

          <fieldset class='payment-methods'>
            <legend class='sr-only'>Selecciona tu m√©todo de pago</legend>
            {
              paymentMethods.map((method) => (
                <label
                  class={`payment-method ${!method.is_active ? 'disabled' : ''}`}
                >
                  <input
                    type='radio'
                    name='paymentMethod'
                    value={method.payment_method}
                    disabled={!method.is_active}
                    required
                  />
                  <div class='method-content'>
                    <div
                      class='method-icon'
                      aria-hidden='true'
                    >
                      {method.payment_method === 'bizum'
                        ? 'üì±'
                        : method.payment_method === 'cash'
                          ? 'ü§ù'
                          : 'üè¶'}
                    </div>
                    <div class='method-info'>
                      <div class='method-name'>
                        {method.payment_method === 'bizum'
                          ? 'Bizum'
                          : method.payment_method === 'cash'
                            ? 'En efectivo'
                            : 'Transferencia'}
                      </div>
                      <div class='method-description'>
                        {method.payment_method === 'bizum'
                          ? 'Pago instant√°neo desde tu m√≥vil'
                          : method.payment_method === 'cash'
                            ? 'Pago en mano'
                            : 'Transferencia bancaria'}
                      </div>
                    </div>
                  </div>
                </label>
              ))
            }
          </fieldset>

          <!-- Instrucciones din√°micas -->
          <div
            class='payment-instructions'
            id='paymentInstructions'
            style='display:none'
            role='region'
            aria-live='polite'
          >
            <div
              class='instructions-content'
              id='instructionsContent'
            >
            </div>
          </div>

          <div class='security-info'>
            <div class='security-badge'>
              <span
                class='security-icon'
                aria-hidden='true'
                >üîí</span
              >
              <span class='security-text'>Contribuci√≥n 100% segura</span>
            </div>
            <div class='trust-indicators'>
              <span class='trust-item'>Familiar</span>
              <span class='trust-item'>Seguro</span>
              <span class='trust-item'>Directo</span>
            </div>
          </div>
        </section>

        <section class='terms-section'>
          <div class='checkbox-group'>
            <input
              type='checkbox'
              id='acceptTerms'
              name='acceptTerms'
              required
            />
            <label for='acceptTerms'>
              Acepto los <a
                href='#'
                class='terms-link'
                >t√©rminos y condiciones</a
              >
              y entiendo que es un proyecto familiar
            </label>
          </div>
        </section>
      </div>
    </form>

    <div
      class='loading-overlay'
      id='loadingOverlay'
      style='display:none'
      role='status'
      aria-live='assertive'
    >
      <div class='loading-content'>
        <div
          class='loading-spinner'
          aria-hidden='true'
        >
        </div>
        <div class='loading-text'>Procesando tu contribuci√≥n...</div>
        <div class='loading-subtext'>Por favor, no cierres esta ventana</div>
      </div>
    </div>
  </div>

  <div slot='modal-footer'>
    <div class='footer-summary'>
      <div class='total-amount'>
        <span class='total-label'>{totalLabel}</span>
        <span
          class='total-value'
          id='totalAmount'
          >0 {currency}</span
        >
      </div>
    </div>

    <div class='footer-actions'>
      <button
        type='button'
        class='cancel-button'
        id='cancelContribution'
      >
        {cancelButtonText}
      </button>
      <button
        type='submit'
        form='contributionForm'
        class='contribute-final-button'
        id='finalContributeButton'
        disabled
      >
        <span
          class='button-icon'
          aria-hidden='true'
          >üöÄ</span
        >
        <span class='button-text'>{confirmButtonText}</span>
        <span
          class='button-icon'
          aria-hidden='true'
          >‚ú®</span
        >
      </button>
    </div>
  </div>
</Modal>

<style>
  .contribution-form {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* Screen Reader Only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .modal-icon {
    font-size: 3rem;
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
    animation: bounce 2s infinite;
  }

  .modal-subtitle {
    font-size: 1rem;
    opacity: 0.9;
  }

  /* Resumen de Contribuci√≥n */
  .contribution-summary {
    background: linear-gradient(145deg, #fff3e0, #ffcc02);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    border: 2px solid #ff9800;
  }

  .summary-header h3 {
    font-family: 'Fredoka One', cursive;
    color: #e65100;
    margin-bottom: 15px;
    font-size: 1.3rem;
  }

  .selected-level {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
  }

  .level-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .level-details {
    flex: 1;
  }

  .level-name {
    font-weight: 700;
    color: #333;
    font-size: 1.2rem;
    margin-bottom: 5px;
  }

  .level-description {
    color: #666;
    font-size: 0.9rem;
  }

  .level-amount {
    font-size: 1.8rem;
    font-weight: 800;
    color: #ff9800;
  }

  /* Recompensas */
  .rewards-section {
    margin-top: 15px;
  }

  .rewards-title {
    font-size: 1.1rem;
    color: #e65100;
    margin-bottom: 10px;
    font-weight: 600;
  }

  .rewards-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .reward-item {
    background: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    border: 1px solid #ff9800;
    color: #e65100;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* Formulario */
  .contributor-form {
    margin-bottom: 25px;
  }

  .form-title {
    font-family: 'Fredoka One', cursive;
    color: #333;
    margin-bottom: 20px;
    font-size: 1.3rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .form-group {
    position: relative;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-family: inherit;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-group input:invalid:not(:focus) {
    border-color: #e74c3c;
  }

  .input-icon {
    position: absolute;
    right: 15px;
    top: 38px;
    font-size: 1.2rem;
    pointer-events: none;
  }

  .char-counter {
    position: absolute;
    right: 10px;
    bottom: 8px;
    font-size: 0.8rem;
    color: #999;
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }

  .checkbox-group input[type='checkbox'] {
    width: auto;
    margin: 0;
  }

  /* M√©todos de Pago */
  .payment-section {
    margin-bottom: 25px;
  }

  .payment-title {
    font-family: 'Fredoka One', cursive;
    color: #333;
    margin-bottom: 20px;
    font-size: 1.3rem;
  }

  .payment-methods {
    border: none;
    padding: 0;
    margin: 0 0 20px 0;
    display: grid;
    gap: 10px;
  }

  .payment-method {
    display: block;
    padding: 0;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    position: relative;
  }

  .payment-method input[type='radio'] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .method-content {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
  }

  .payment-method:hover:not(.disabled) {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .payment-method:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .payment-method input[type='radio']:checked + .method-content {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .payment-method input[type='radio']:checked + .method-content::after {
    content: '‚úì';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: #667eea;
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .payment-method.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f5f5f5;
  }

  .method-icon {
    font-size: 2rem;
    width: 50px;
    text-align: center;
  }

  .method-info {
    flex: 1;
  }

  .method-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 3px;
  }

  .method-description {
    font-size: 0.85rem;
    color: #666;
  }

  /* Instrucciones de pago */
  .payment-instructions {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #17a2b8;
    margin-top: 15px;
  }

  .instructions-content h4 {
    color: #17a2b8;
    margin-bottom: 15px;
    font-family: 'Fredoka One', cursive;
  }

  .bank-details {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
  }

  .detail-label {
    font-weight: 600;
    color: #666;
  }

  .detail-value {
    color: #333;
    font-family: monospace;
    font-weight: 600;
  }

  .copy-button {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    margin-left: 10px;
    transition: background 0.2s;
  }

  .copy-button:hover {
    background: #138496;
  }

  .copy-button:focus {
    outline: 2px solid #17a2b8;
    outline-offset: 2px;
  }

  /* Informaci√≥n de Seguridad */
  .security-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .security-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #2e7d32;
    font-weight: 600;
  }

  .trust-indicators {
    display: flex;
    gap: 10px;
  }

  .trust-item {
    background: #2e7d32;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* T√©rminos y Condiciones */
  .terms-section {
    margin-bottom: 20px;
  }

  .terms-section .checkbox-group label {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.4;
  }

  .terms-link {
    color: #667eea;
    text-decoration: none;
  }

  .terms-link:hover {
    text-decoration: underline;
  }

  .terms-link:focus {
    outline: 2px solid #667eea;
    outline-offset: 1px;
  }

  /* Footer del Modal */
  .footer-summary {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .total-amount {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .total-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 2px;
  }

  .total-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: #2e7d32;
  }

  .footer-actions {
    display: flex;
    gap: 15px;
  }

  .cancel-button {
    padding: 12px 25px;
    border: 2px solid #e0e0e0;
    background: white;
    color: #666;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .cancel-button:hover {
    border-color: #ccc;
    background: #f5f5f5;
  }

  .cancel-button:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
  }

  .contribute-final-button {
    background: linear-gradient(145deg, #4caf50, #45a049);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }

  .contribute-final-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
  }

  .contribute-final-button:focus {
    outline: 2px solid white;
    outline-offset: 2px;
  }

  .contribute-final-button:disabled {
    background: #cccccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Loading Overlay */
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    border-radius: 20px;
  }

  .loading-content {
    text-align: center;
    padding: 40px;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  .loading-text {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
  }

  .loading-subtext {
    font-size: 0.9rem;
    color: #666;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Modal de √âxito */
  .success-container {
    padding: 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
    background: white;
    border-radius: 20px;
  }

  .success-animation {
    position: relative;
    margin-bottom: 25px;
  }

  .success-icon {
    font-size: 5rem;
    margin-bottom: 15px;
    animation: successBounce 1s ease-out;
  }

  .success-rings {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .ring {
    position: absolute;
    border: 3px solid #4caf50;
    border-radius: 50%;
    opacity: 0;
    animation: ringExpand 2s ease-out infinite;
  }

  .ring-1 {
    width: 100px;
    height: 100px;
    margin: -50px 0 0 -50px;
    animation-delay: 0s;
  }

  .ring-2 {
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    animation-delay: 0.5s;
  }

  .ring-3 {
    width: 200px;
    height: 200px;
    margin: -100px 0 0 -100px;
    animation-delay: 1s;
  }

  @keyframes successBounce {
    0% {
      transform: scale(0);
    }
    60% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  @keyframes ringExpand {
    0% {
      opacity: 0;
      transform: scale(0.5);
    }
    50% {
      opacity: 0.8;
    }
    100% {
      opacity: 0;
      transform: scale(1.2);
    }
  }

  .success-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2rem;
    color: #4caf50;
    margin-bottom: 15px;
  }

  .success-message {
    font-size: 1.1rem;
    color: #555;
    line-height: 1.6;
    margin-bottom: 25px;
  }

  .success-details {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    text-align: left;
  }

  .success-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
  }

  .share-button,
  .close-success-button {
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    border: none;
  }

  .share-button {
    background: linear-gradient(145deg, #2196f3, #1976d2);
    color: white;
  }

  .close-success-button {
    background: #e0e0e0;
    color: #666;
  }

  .share-button:hover,
  .close-success-button:hover {
    transform: translateY(-2px);
  }

  .share-button:focus,
  .close-success-button:focus {
    outline: 2px solid #2196f3;
    outline-offset: 2px;
  }

  /* Animaciones Generales */
  @keyframes bounce {
    0%,
    20%,
    50%,
    80%,
    100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-10px);
    }
    60% {
      transform: translateY(-5px);
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .footer-actions {
      flex-direction: column;
      width: 100%;
    }

    .cancel-button,
    .contribute-final-button {
      width: 100%;
      justify-content: center;
    }

    .success-container {
      padding: 30px 20px;
    }

    .success-actions {
      flex-direction: column;
    }

    .security-info {
      flex-direction: column;
      gap: 10px;
      text-align: center;
    }

    .payment-instructions {
      padding: 15px;
    }

    .loading-content {
      padding: 30px 20px;
    }
  }

  @media (max-width: 480px) {
    .level-info {
      flex-direction: column;
      text-align: center;
      gap: 10px;
    }

    .payment-method .method-content {
      padding: 12px;
    }

    .method-icon {
      font-size: 1.5rem;
      width: 40px;
    }

    .contribution-summary,
    .contributor-form,
    .payment-section {
      margin-bottom: 20px;
    }
  }

  /* Soporte para navegadores que no tienen :focus-visible */
  @supports not selector(:focus-visible) {
    button:focus,
    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }
  }

  /* Mejoras para focus-visible */
  @supports selector(:focus-visible) {
    button:focus:not(:focus-visible),
    input:focus:not(:focus-visible),
    select:focus:not(:focus-visible),
    textarea:focus:not(:focus-visible) {
      outline: none;
    }

    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }
  }
</style>

<script>
  import {
    createContribution,
    type PaymentInstructionsTemplate,
    type PaymentMethodConfig,
    type PaymentMethodId,
  } from '../lib/supabase';

  class ContributionModalManager {
    private loadingOverlay: HTMLElement;
    private form: HTMLFormElement;

    private selectedLevel: any = null;

    private clientPaymentMethods: PaymentMethodConfig[] = [];
    private clientCurrency: string = '‚Ç¨';

    private bizumNumber: string = '';
    private bizumConcept: string = '';
    private projectId: string | null = null;

    constructor() {
      this.loadingOverlay = document.getElementById('loadingOverlay')!;
      this.form = document.getElementById(
        'contributionForm'
      ) as HTMLFormElement;

      const dataNode = document.getElementById('contributionModalData');
      if (dataNode) {
        try {
          const raw = dataNode.getAttribute('data-payment-methods');
          this.clientPaymentMethods = raw ? JSON.parse(raw) : [];
        } catch {
          this.clientPaymentMethods = [];
        }

        this.projectId = dataNode.getAttribute('data-project-id') || null;
        this.clientCurrency =
          dataNode.getAttribute('data-currency') || this.clientCurrency;

        // fallbacks (si no vienen desde method config)
        this.bizumNumber = dataNode.getAttribute('data-bizum-number') || '';
        this.bizumConcept = dataNode.getAttribute('data-bizum-concept') || '';
      }

      this.init();
    }

    private init() {
      this.setupModalControls();
      this.setupFormHandling();
      this.setupPaymentMethodChange();
      this.setupCopyButtons();

      document.addEventListener('levelSelected', (e: any) => {
        this.handleLevelSelected(e.detail);
      });
    }

    private setupModalControls() {
      document
        .getElementById('cancelContribution')
        ?.addEventListener('click', () => {
          this.closeModal();
        });
    }

    private setupFormHandling() {
      const inputs = this.form.querySelectorAll('input, textarea, select');
      inputs.forEach((input) => {
        input.addEventListener('input', () => this.validateForm());
        input.addEventListener('change', () => this.validateForm());
      });

      const messageInput = document.getElementById(
        'contributorMessage'
      ) as HTMLTextAreaElement | null;
      const charCounter = document.getElementById('charCounter');

      messageInput?.addEventListener('input', () => {
        const count = messageInput.value.length;
        if (charCounter) {
          charCounter.textContent = `${count}/150`;
          (charCounter as HTMLElement).style.color =
            count > 140 ? '#f44336' : '#999';
        }
      });

      this.form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleFormSubmit();
      });
    }

    private setupPaymentMethodChange() {
      document.querySelectorAll('input[name="paymentMethod"]').forEach((el) => {
        el.addEventListener('change', () => {
          const value = (el as HTMLInputElement).value as PaymentMethodId;
          this.handlePaymentMethodChange(value);
        });
      });
    }

    private getMethodConfig(
      methodId: PaymentMethodId
    ): PaymentMethodConfig | null {
      return (
        this.clientPaymentMethods.find((m) => m.payment_method === methodId) ||
        null
      );
    }

    private parseTemplate(raw: unknown): PaymentInstructionsTemplate | null {
      if (!raw) return null;

      // Ya es objeto (lo ideal)
      if (typeof raw === 'object') return raw as PaymentInstructionsTemplate;

      // Viene como string JSON
      if (typeof raw === 'string') {
        try {
          return JSON.parse(raw) as PaymentInstructionsTemplate;
        } catch (e) {
          console.warn('instructions is not valid JSON:', raw);
          return null;
        }
      }

      return null;
    }

    private handlePaymentMethodChange(methodId: PaymentMethodId) {
      const instructionsContainer = document.getElementById(
        'paymentInstructions'
      ) as HTMLElement | null;
      const instructionsContent = document.getElementById(
        'instructionsContent'
      ) as HTMLElement | null;
      if (!instructionsContainer || !instructionsContent) return;

      instructionsContainer.style.display = 'none';
      instructionsContent.innerHTML = '';

      const methodConfig = this.getMethodConfig(methodId);
      if (!methodConfig || !methodConfig.is_active) return;

      // Variables comunes
      const amount = String(this.selectedLevel?.amount ?? 0);
      const currency = this.clientCurrency || '‚Ç¨';

      // Bizum: usa bizum_phone de config si existe, si no usa fallback del proyecto
      if (methodId === 'bizum') {
        const bizumPhone = (
          methodConfig.bizum_phone ||
          this.bizumNumber ||
          ''
        ).trim();
        if (!bizumPhone) {
          instructionsContent.innerHTML = `<p style="color:#b71c1c;">‚ö†Ô∏è Este proyecto no tiene Bizum configurado.</p>`;
          instructionsContainer.style.display = 'block';
          return;
        }

        const concept = (this.bizumConcept || '').trim();

        const template = this.parseTemplate(
          this.parseTemplate(methodConfig.instructions)
        ) as PaymentInstructionsTemplate;

        instructionsContent.innerHTML = this.renderInstructionsTemplate(
          template,
          {
            bizum_phone: bizumPhone,
            amount,
            currency,
            concept,
          }
        );

        instructionsContainer.style.display = 'block';
        return;
      }

      // Cash: renderiza template desde DB
      if (methodId === 'cash') {
        const template = this.parseTemplate(
          methodConfig.instructions
        ) as PaymentInstructionsTemplate;

        instructionsContent.innerHTML = this.renderInstructionsTemplate(
          template,
          {
            bizum_phone: '',
            amount,
            currency,
            concept: '',
          }
        );

        instructionsContainer.style.display = 'block';
        return;
      }

      // bank_transfer: si lo activas en el futuro‚Ä¶
      const template = this.parseTemplate(methodConfig.instructions);
      if (template) {
        instructionsContent.innerHTML = this.renderInstructionsTemplate(
          template,
          {
            bizum_phone: '',
            amount,
            currency,
            concept: template.concept || '',
          }
        );
        instructionsContainer.style.display = 'block';
      }
    }

    private renderInstructionsTemplate(
      template: PaymentInstructionsTemplate,
      vars: {
        bizum_phone: string;
        amount: string;
        currency: string;
        concept: string;
      }
    ): string {
      const replaceVars = (s: string) =>
        s
          .replaceAll('{{bizum_phone}}', vars.bizum_phone)
          .replaceAll('{{amount}}', vars.amount)
          .replaceAll('{{currency}}', vars.currency)
          .replaceAll('{{concept}}', vars.concept);

      const stepsHtml = (template.steps || [])
        .map((step) => `<li>${replaceVars(step)}</li>`)
        .join('');

      const tipHtml = template.tip
        ? `<div class="instructions-tip"><strong>üí° Tip:</strong> ${replaceVars(template.tip)}</div>`
        : '';

      const copyBtn = vars.bizum_phone
        ? `<button type="button" class="copy-button" data-copy="${vars.bizum_phone.replace(/\D/g, '')}">üìã Copiar</button>`
        : '';

      const bizumRow = vars.bizum_phone
        ? `
          <div class="detail-row">
            <span class="detail-label">N√∫mero Bizum:</span>
            <span class="detail-value">${vars.bizum_phone}</span>
            ${copyBtn}
          </div>
        `
        : '';

      const conceptRow = vars.concept
        ? `
            <div class="detail-row">
              <span class="detail-label">Concepto:</span>
              <span class="detail-value">${vars.concept}</span>
            </div>
          `
        : '';
      return `
        <h4>${template.title}</h4>
        <div class="bank-details">
          ${bizumRow}
          <div class="detail-row">
            <span class="detail-label">Importe:</span>
            <span class="detail-value">${vars.amount} ${vars.currency}</span>
          </div>
          ${conceptRow}
        </div>
        <p><strong>üìã Pasos:</strong></p>
        <ol style="margin: 10px 0; padding-left: 20px;">
          ${stepsHtml}
        </ol>
        ${tipHtml}
      `;
    }

    private validateForm(): boolean {
      const submitButton = document.getElementById(
        'finalContributeButton'
      ) as HTMLButtonElement | null;
      const isValid = this.form.checkValidity() && this.selectedLevel;

      if (submitButton) {
        submitButton.disabled = !isValid;
        submitButton.style.opacity = isValid ? '1' : '0.6';
      }

      return isValid;
    }

    private async handleFormSubmit() {
      if (!this.validateForm()) return;

      this.showLoading();

      try {
        const formData = new FormData(this.form);
        const contributionData: any = {
          levelId: String(formData.get('levelId') || ''),
          amount: Number(formData.get('amount')),
          contributorName: String(formData.get('contributorName') || ''),
          contributorEmail: String(formData.get('contributorEmail') || ''),
          contributorMessage: String(formData.get('contributorMessage') || ''),
          contributorEmoji: String(formData.get('contributorEmoji') || ''),
          isAnonymous: formData.get('isAnonymous') === 'on',
          paymentMethod: String(formData.get('paymentMethod') || ''),
          projectId: this.projectId,
        };

        const result = await this.submitContribution(contributionData);

        this.hideLoading();

        if (result?.success) {
          // aqu√≠ ya har√≠as tu modal de success como antes
          alert('‚úÖ Contribuci√≥n registrada');
          this.closeModal();
        } else {
          alert(result?.error || 'Error al procesar la contribuci√≥n');
        }
      } catch {
        this.hideLoading();
        alert('Error al enviar la contribuci√≥n. Int√©ntalo de nuevo.');
      }
    }

    private async submitContribution(
      data: any
    ): Promise<{ success: boolean; error?: string } | null> {
      try {
        const res = await createContribution({
          contributorName: data.contributorName,
          contributorEmail: data.contributorEmail,
          contributorEmoji: data.contributorEmoji,
          amount: Number(data.amount),
          levelId: data.levelId || null,
          levelName: data.levelName || null,
          contributorMessage: data.contributorMessage,
          paymentMethod: data.paymentMethod,
          isAnonymous: !!data.isAnonymous,
          metadata: data.metadata || null,
          projectId: data.projectId || '',
        });

        if (!res?.success) {
          return {
            success: false,
            error: res?.error || 'Error en createContribution',
          };
        }

        document.dispatchEvent(
          new CustomEvent('contributionCompleted', {
            detail: {
              amount: this.selectedLevel?.amount ?? 0,
              contributor: {
                name: data.contributorName,
                emoji: data.contributorEmoji,
                message: data.contributorMessage,
                level: this.selectedLevel?.name ?? '',
                color: this.selectedLevel?.color || '#4caf50',
                isAnonymous: data.isAnonymous,
              },
            },
          })
        );

        return { success: true };
      } catch (err: any) {
        return { success: false, error: err?.message || String(err) };
      }
    }

    private showLoading() {
      this.loadingOverlay.style.display = 'flex';
    }

    private hideLoading() {
      this.loadingOverlay.style.display = 'none';
    }

    private closeModal() {
      window.closeModal?.('contributionModal');
      this.resetForm();
    }

    private resetForm() {
      this.form.reset();
      const charCounter = document.getElementById('charCounter');
      if (charCounter) charCounter.textContent = '0/150';
      const inst = document.getElementById(
        'paymentInstructions'
      ) as HTMLElement | null;
      if (inst) inst.style.display = 'none';
      this.validateForm();
    }

    private handleLevelSelected(levelData: any) {
      this.selectedLevel = levelData;
      this.updateModalContent();
      window.openModal?.('contributionModal');

      setTimeout(() => {
        (
          document.getElementById('contributorName') as HTMLInputElement | null
        )?.focus();
      }, 100);
    }

    private updateModalContent() {
      if (!this.selectedLevel) return;
      (document.getElementById(
        'levelEmoji'
      ) as HTMLElement | null)!.textContent = this.selectedLevel.emoji;
      (document.getElementById(
        'levelName'
      ) as HTMLElement | null)!.textContent = this.selectedLevel.name;
      (document.getElementById(
        'levelDescription'
      ) as HTMLElement | null)!.textContent =
        `Nivel ${this.selectedLevel.name} - ¬°Gracias por tu apoyo!`;
      (document.getElementById(
        'levelAmount'
      ) as HTMLElement | null)!.textContent =
        `${this.selectedLevel.amount} ${this.clientCurrency}`;
      (document.getElementById(
        'totalAmount'
      ) as HTMLElement | null)!.textContent =
        `${this.selectedLevel.amount} ${this.clientCurrency}`;

      (document.getElementById(
        'selectedLevelId'
      ) as HTMLInputElement | null)!.value = this.selectedLevel.id;
      (document.getElementById(
        'selectedAmount'
      ) as HTMLInputElement | null)!.value = String(this.selectedLevel.amount);

      this.validateForm();
    }

    private setupCopyButtons() {
      document.addEventListener('click', async (e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains('copy-button')) {
          const textToCopy = target.dataset.copy;
          if (!textToCopy) return;

          try {
            await navigator.clipboard.writeText(textToCopy);
            const original = target.textContent;
            target.textContent = '‚úÖ Copiado';
            setTimeout(
              () => (target.textContent = original || 'üìã Copiar'),
              1500
            );
          } catch {
            alert('No se pudo copiar al portapapeles');
          }
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new ContributionModalManager();
  });
</script>
