---
import type { PublicContribution } from '../lib/supabase';

export interface Props {
  contributors?: PublicContribution[];
  currency?: string;
  showTotal?: boolean;
  maxDisplay?: number;
  contributorsTitle?: string;
  contributorsLevels?: {
    name: string;
    color: string;
    emoji: string;
  }[];
}

const {
  contributors = [],
  currency = '‚Ç¨',
  showTotal = true,
  maxDisplay = 20,
  contributorsTitle = '',
} = Astro.props;

// Calcular estad√≠sticas
const totalContributors = contributors.length;
const totalAmount = contributors.reduce((sum, c) => sum + c.amount, 0);
const displayedContributors = contributors.slice(0, maxDisplay);
const hiddenCount = Math.max(0, totalContributors - maxDisplay);
---

<div class='contributors-section'>
  <div class='section-header'>
    <h3 class='section-title'>{contributorsTitle}</h3>
    <div class='section-stats'>
      <div class='stat-badge'>
        <span class='stat-number'>{totalContributors}</span>
        <span class='stat-label'>H√©roes</span>
      </div>
      {
        showTotal && (
          <div class='stat-badge total'>
            <span class='stat-number'>
              {totalAmount.toFixed(2)} {currency}
            </span>
            <span class='stat-label'>Recaudado</span>
          </div>
        )
      }
    </div>
  </div>

  <div
    class='contributors-grid'
    id='contributorsGrid'
  >
    {
      displayedContributors.map((contributor, index) => (
        <div
          class='contributor-card'
          data-contributor-id={contributor.id}
          style={`--contributor-color: ${contributor.level_color}; --animation-delay: ${index * 0.1}s`}
        >
          <div class='contributor-avatar'>
            <span class='avatar-emoji'>{contributor.contributor_emoji}</span>
            <div class='avatar-ring' />
            <div
              class='level-badge'
              title={`Nivel: ${contributor.level_name}`}
            >
              {contributor.level_emoji}
            </div>
          </div>

          <div class='contributor-info'>
            <div class='contributor-name'>{contributor.contributor_name}</div>
            <div class='contributor-amount'>
              {contributor.amount} {currency}
            </div>
            <div class='contributor-level'>{contributor.level_name}</div>
            <div class='contributor-date'>
              {new Date(contributor.created_at).toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'short',
              })}
            </div>
          </div>

          {contributor.message && (
            <div class='contributor-message'>
              <div class='message-bubble'>
                <span class='message-text'>"{contributor.message}"</span>
                <div class='message-arrow' />
              </div>
            </div>
          )}
        </div>
      ))
    }
  </div>

  {
    hiddenCount > 0 && (
      <div class='more-contributors'>
        <button
          class='show-more-btn'
          id='showMoreBtn'
        >
          <span class='btn-text'>Ver {hiddenCount} h√©roes m√°s</span>
          <span class='btn-icon'>üë•</span>
        </button>
      </div>
    )
  }
</div>

<style>
  .contributors-section {
    background: linear-gradient(145deg, #f3e5f5, #e1bee7);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
  }

  .contributors-section::before {
    content: 'üëë';
    position: absolute;
    top: -15px;
    right: -15px;
    font-size: 120px;
    opacity: 0.1;
    transform: rotate(15deg);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }

  .section-title {
    font-family: 'Fredoka One', cursive;
    font-size: 1.8rem;
    color: #7b1fa2;
    margin: 0;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
  }

  .section-stats {
    display: flex;
    gap: 15px;
  }

  .stat-badge {
    background: white;
    padding: 10px 15px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 2px solid #e1bee7;
  }

  .stat-badge.total {
    border-color: #4caf50;
    background: linear-gradient(145deg, #e8f5e8, #c8e6c8);
  }

  .stat-number {
    display: block;
    font-size: 1.2rem;
    font-weight: 700;
    color: #7b1fa2;
  }

  .stat-badge.total .stat-number {
    color: #2e7d32;
  }

  .stat-label {
    display: block;
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  .contributors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .contributor-card {
    background: white;
    border-radius: 18px;
    padding: 20px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
    animation: fadeInUp 0.6s ease-out var(--animation-delay);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .contributor-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    border-color: var(--contributor-color);
  }

  .contributor-card:hover .sparkle {
    opacity: 1;
    animation: sparkleFloat 2s ease-in-out infinite;
  }

  .contributor-avatar {
    position: relative;
    width: 70px;
    height: 70px;
    margin: 0 auto 15px;
  }

  .avatar-emoji {
    width: 70px;
    height: 70px;
    background: linear-gradient(
      145deg,
      var(--contributor-color),
      color-mix(in srgb, var(--contributor-color) 80%, black)
    );
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
    position: relative;
    z-index: 2;
  }

  .avatar-ring {
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border: 3px solid var(--contributor-color);
    border-radius: 50%;
    opacity: 0;
    animation: ringPulse 2s ease-in-out infinite;
  }

  @keyframes ringPulse {
    0%,
    100% {
      opacity: 0;
      transform: scale(1);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.1);
    }
  }

  .level-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    border: 2px solid var(--contributor-color);
    z-index: 3;
  }

  .contributor-info {
    text-align: center;
    margin-bottom: 15px;
  }

  .contributor-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
  }

  .contributor-amount {
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--contributor-color);
    margin-bottom: 5px;
  }

  .contributor-level {
    font-size: 0.9rem;
    color: #666;
    font-weight: 600;
    margin-bottom: 5px;
  }

  .contributor-date {
    font-size: 0.8rem;
    color: #999;
    font-style: italic;
  }

  .contributor-message {
    margin-top: 15px;
  }

  .message-bubble {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    padding: 12px 15px;
    position: relative;
    border-left: 4px solid var(--contributor-color);
  }

  .message-text {
    font-size: 0.9rem;
    color: #555;
    font-style: italic;
    line-height: 1.4;
  }

  .contributor-effects {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
  }

  .sparkle {
    position: absolute;
    font-size: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .sparkle-1 {
    top: 20%;
    left: 15%;
  }

  .sparkle-2 {
    top: 30%;
    right: 20%;
  }

  .sparkle-3 {
    bottom: 25%;
    left: 25%;
  }

  @keyframes sparkleFloat {
    0%,
    100% {
      transform: translateY(0px) rotate(0deg);
    }
    50% {
      transform: translateY(-5px) rotate(180deg);
    }
  }

  .more-contributors {
    text-align: center;
    margin-bottom: 25px;
  }

  .show-more-btn {
    background: linear-gradient(145deg, #7b1fa2, #9c27b0);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 auto;
  }

  .show-more-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(123, 31, 162, 0.3);
  }

  .contributors-cta {
    background: linear-gradient(145deg, #fff3e0, #ffcc02);
    border-radius: 15px;
    padding: 25px;
    border: 2px solid #ff9800;
    text-align: center;
  }

  .cta-title {
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    color: #e65100;
    margin-bottom: 10px;
  }

  .cta-description {
    font-size: 1rem;
    color: #555;
    line-height: 1.5;
    margin-bottom: 20px;
  }

  .preview-card {
    display: flex;
    align-items: center;
    gap: 15px;
    background: white;
    padding: 15px;
    border-radius: 12px;
    max-width: 250px;
    margin: 0 auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 2px dashed #ff9800;
    animation: previewPulse 3s ease-in-out infinite;
  }

  @keyframes previewPulse {
    0%,
    100% {
      transform: scale(1);
      opacity: 0.8;
    }
    50% {
      transform: scale(1.05);
      opacity: 1;
    }
  }

  .preview-avatar {
    position: relative;
    width: 50px;
    height: 50px;
  }

  .preview-emoji {
    width: 50px;
    height: 50px;
    background: linear-gradient(145deg, #ff9800, #f57c00);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .preview-ring {
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 2px solid #ff9800;
    border-radius: 50%;
    opacity: 0.6;
    animation: ringPulse 2s ease-in-out infinite;
  }

  .preview-info {
    text-align: left;
  }

  .preview-name {
    font-weight: 700;
    color: #333;
    margin-bottom: 2px;
  }

  .preview-level {
    font-size: 0.9rem;
    color: #666;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .contributors-section {
      padding: 20px;
    }

    .section-header {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .contributors-grid {
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .contributor-card {
      padding: 15px;
    }

    .section-title {
      font-size: 1.5rem;
    }

    .preview-card {
      flex-direction: column;
      text-align: center;
    }
  }

  @media (max-width: 480px) {
    .contributor-avatar {
      width: 60px;
      height: 60px;
    }

    .avatar-emoji {
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
    }

    .level-badge {
      width: 25px;
      height: 25px;
      font-size: 0.8rem;
    }
  }
</style>

<script>
  class ContributorsList {
    private showMoreBtn: HTMLElement | null;
    private contributorsGrid: HTMLElement;

    constructor() {
      this.showMoreBtn = document.getElementById('showMoreBtn');
      this.contributorsGrid = document.getElementById('contributorsGrid')!;
      this.init();
    }

    private init() {
      // Event listener para el bot√≥n "Ver m√°s"
      if (this.showMoreBtn) {
        this.showMoreBtn.addEventListener('click', () =>
          this.showMoreContributors()
        );
      }

      // Listener para nuevas contribuciones
      document.addEventListener('levelSelected', (event: any) => {
        this.handleNewContribution(event.detail);
      });

      // Animar cartas al cargar
      this.animateCardsOnLoad();
    }

    private animateCardsOnLoad() {
      const cards = document.querySelectorAll('.contributor-card');
      cards.forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('animate-in');
        }, index * 100);
      });
    }

    private showMoreContributors() {
      // Simular carga de m√°s contribuyentes
      if (this.showMoreBtn) {
        this.showMoreBtn.innerHTML = '<span>Cargando...</span> üîÑ';

        setTimeout(() => {
          this.showMoreBtn!.style.display = 'none';
          // Aqu√≠ se a√±adir√≠an las nuevas cartas al grid
          this.addLoadingMessage();
        }, 1000);
      }
    }

    private addLoadingMessage() {
      const messageCard = document.createElement('div');
      messageCard.className = 'contributor-card';
      messageCard.style.cssText = '--contributor-color: #9e9e9e';
      messageCard.innerHTML = `
                <div class="contributor-info">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üì¶</div>
                    <div class="contributor-name">M√°s h√©roes pr√≥ximamente</div>
                    <div style="color: #666; font-size: 0.9rem;">La aventura contin√∫a...</div>
                </div>
            `;

      this.contributorsGrid.appendChild(messageCard);
    }

    private handleNewContribution(levelData: any) {
      // Simular a√±adir una nueva contribuci√≥n
      console.log('Nueva contribuci√≥n simulada:', levelData);

      // En una implementaci√≥n real, esto se enviar√≠a al servidor
      // y se actualizar√≠a la lista de contribuyentes
    }

    // M√©todo p√∫blico para a√±adir un contribuyente
    public addContributor(contributor: any) {
      const contributorCard = this.createContributorCard(contributor);
      this.contributorsGrid.appendChild(contributorCard);

      // Animar la entrada
      setTimeout(() => {
        contributorCard.classList.add('animate-in');
      }, 100);
    }

    private createContributorCard(contributor: any): HTMLElement {
      const card = document.createElement('div');
      card.className = 'contributor-card';
      card.style.cssText = `--contributor-color: ${contributor.color}`;

      card.innerHTML = `
                <div class="contributor-avatar">
                    <span class="avatar-emoji">${contributor.emoji}</span>
                    <div class="avatar-ring"></div>
                    <div class="level-badge">${contributor.levelEmoji}</div>
                </div>
                <div class="contributor-info">
                    <div class="contributor-name">${contributor.name}</div>
                    <div class="contributor-amount">${contributor.amount} ‚Ç¨</div>
                    <div class="contributor-level">${contributor.level}</div>
                    <div class="contributor-date">Ahora</div>
                </div>
                <div class="contributor-effects">
                    <div class="sparkle sparkle-1">‚ú®</div>
                    <div class="sparkle sparkle-2">‚≠ê</div>
                    <div class="sparkle sparkle-3">üí´</div>
                </div>
            `;

      return card;
    }
  }

  // Estilos adicionales para animaciones
  const additionalStyles = document.createElement('style');
  additionalStyles.textContent = `
        .contributor-card.animate-in {
            animation: slideInScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    `;
  document.head.appendChild(additionalStyles);

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', () => {
    new ContributorsList();
  });

  // Exponer globalmente
  (window as any).contributorsList = ContributorsList;
</script>
